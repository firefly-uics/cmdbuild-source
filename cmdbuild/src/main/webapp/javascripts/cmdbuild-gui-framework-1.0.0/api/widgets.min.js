!function(a){var e={saveMethod:a.Cmdbuild.widgets.SAVEONCARD,save:function(e,i){var t=this.formName(e,i),d=a.Cmdbuild.dataModel.forms[t];if(!d)return{};var l={};for(var n in d.checked){var s=d.checked[n];s&&(l[n]={})}return l},formName:function(a,e){var i=a+"_"+e._id+"grid";return i},cleanData:function(e,i){var t=this.formName(e,i);a.Cmdbuild.dataModel.cleanForm(t)}};a.Cmdbuild.widgets.LinkCards=e}(jQuery),function(a){var e={ROWBUTTONREGENERATE:"refresh",ROWBUTTONREPLY:"btnIconReply",ROWBUTTONDELETE:"deleteIconButton",ROWBUTTONMODIFY:"pencilGoIcon",mailAttributes:["account","bcc","body","cc","date","delay","from","_id","keepSynchronization","noSubjectPrefix","notifyWith","promptSynchronization","status","subject","template","to"],template2MailTable:{account:"account",bccAddresses:"bcc",content:"body",toAddresses:"to",ccAddresses:"cc",fromAddress:"from",subject:"subject"},saveMethod:a.Cmdbuild.widgets.SAVEAFTER,save:function(e,i){var t=(this.formName(e,i),a.Cmdbuild.dataModel.forms[e]);if(!t)return{};var d={data:t.getBackendData().mails,bkData:t.getBackendData().bkMails,name:i._id};return d},formName:function(a,e){var i=a+"_"+e._id+"formattachements";return i},cleanData:function(e,i){var t=this.formName(e,i);a.Cmdbuild.dataModel.cleanForm(t)},prepareFields:function(a){for(var e=0;e<a.data.templates.length;e++)a.data.templates[e]=this.template2Mail(a.data.templates[e])},evaluateCql:function(e,i){for(var t=0;t<i.data.templates.length;t++){i.data.templates[t]=i.data.templates[t];var d=i.data.templates[t],l=this.getAttributes(e,i,d,t);this.compileAttributes(e,l),d.attributes=l}a.Cmdbuild.CqlManager.variablesTable.generate(e,a.Cmdbuild.CqlManager.commandsTable)},createField:function(a,e,i,t,d){d.push({name:a,filter:{text:i[a],params:i.variables}})},getAttributes:function(a,e,i,t){var d=[];return this.createField("subject",e._id,i,t,d),this.createField("body",e._id,i,t,d),this.createField("to",e._id,i,t,d),this.createField("from",e._id,i,t,d),this.createField("cc",e._id,i,t,d),this.createField("bcc",e._id,i,t,d),d},setSynchronization:function(a,e,i,t){for(var d=0;d<a.length;d++){var l=a[d];l.promptSynchronization=!1,i&&e[l._id]?l.keepSynchronization=!0:l.keepSynchronization=!1}},compileAttributes:function(e,i){for(var t=0;t<i.length;t++)a.Cmdbuild.CqlManager.compileAttribute(e,i[t])},initialize:function(e,i){var t=a.Cmdbuild.dataModel.forms[e],d=t.getBackendData();d.mails=[],d.bkMails=[];for(var l=0;l<i.data.templates.length;l++){var n=i.data.templates[l],s="guiTmpMail_"+l;n._id=s,d.mails.push({_id:s,status:"draft"}),a.Cmdbuild.widgets.ManageEmail.cqlResolve(e,n,function(){},this)}this.loadMails(t.param,t.getBackend(),function(){},this)},refreshCqlField:function(e,i){var t=a.Cmdbuild.dataModel.forms[e];if(1!=t.initializationPhase&&this.busy!==!0){this.busy=!0;try{for(var d=0;d<i.data.templates.length;d++){var l=i.data.templates[d],n=l.keepSynchronization,s=l.promptSynchronization;if(n)if(s){if(t.initializationPhase===!1){var r=e+"_"+i._id;a.Cmdbuild.dataModel.pushSingleParameterOnStack("widgetName",r),a.Cmdbuild.dataModel.pushSingleParameterOnStack("formData",e),a.Cmdbuild.standard.commands.navigate({command:"navigate",form:"mailSynchronization",dialog:"syncMailDialog"}),l.promptSynchronization=!1}}else a.Cmdbuild.widgets.ManageEmail.cqlResolve(e,l,function(){},this);else;}}catch(o){console.log("Warning: Cmdbuild.widgets.ManageEmail.refreshCqlField ",e),m.busy=!1}var m=this;this.TM=setTimeout(function(){m.busy=!1},500)}},loadMails:function(e,i,t,d){e.cardId?a.Cmdbuild.utilities.proxy.getProcessMails(e.className,e.cardId,function(a){this.callbackLoadMails(i,e.className,e.cardId,a,t,d)},this):t.apply(d,[])},callbackLoadMails:function(e,i,t,d,l,n){if(d.length<=0)return void l.apply(n);var s=d[0];d.splice(0,1),a.Cmdbuild.utilities.proxy.getProcessSingleMail(i,t,s._id,function(s){e.data.mails.push(s),e.data.bkMails.push(a.Cmdbuild.utilities.clone(s)),this.callbackLoadMails(e,i,t,d,l,n)},this)},template2Mail:function(a){var e={};for(var i in a)this.template2MailTable[i]?e[this.template2MailTable[i]]=a[i]:e[i]=a[i];return e}};a.Cmdbuild.widgets.ManageEmail=e,a.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField=function(e,i,t,d,l){var n=a.Cmdbuild.dataModel.forms[e],s=n.getBackendData();a.Cmdbuild.CqlManager.resolve(e,i,function(e){var n=a.Cmdbuild.widgets.ManageEmail.getMail(s.mails,t._id);n[i]=e,n.fromTemplate=t._id,d&&d.apply(l,[e])},this)},a.Cmdbuild.widgets.ManageEmail.cqlResolve=function(e,i,t,d){var l=i.attributes.slice();a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(e,i,l,function(){t.apply(d,[])},this)},a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback=function(e,i,t,d,l){if(t.length<=0)return void d.apply(l,[]);var n=t[0];t.splice(0,1),a.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField(e,n.name,i,function(){a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(e,i,t,d,l)},this)},a.Cmdbuild.widgets.ManageEmail.refreshTemplate=function(e,i,t){for(var d=0;d<i.data.templates.length;d++){var l=i.data.templates[d];if(l._id==t){a.Cmdbuild.widgets.ManageEmail.cqlResolve(e,l,function(){},this);break}}},a.Cmdbuild.widgets.ManageEmail.getMail=function(a,e){for(var i=0;i<a.length;i++)if(a[i]._id==e)return a[i]},a.Cmdbuild.widgets.ManageEmail.isDifferent=function(e,i){for(var t=0;t<a.Cmdbuild.widgets.ManageEmail.mailAttributes.length;t++){var d=a.Cmdbuild.widgets.ManageEmail.mailAttributes[t];if(i[d]!=e[d])return!0}return!1},a.Cmdbuild.widgets.ManageEmail.copyMail=function(e){for(var i={},t=0;t<a.Cmdbuild.widgets.ManageEmail.mailAttributes.length;t++){var d=a.Cmdbuild.widgets.ManageEmail.mailAttributes[t];i[d]=e[d]}return i},a.Cmdbuild.widgets.ManageEmail.deleteMails=function(e,i){for(var t=0;t<i.bkData.length;t++){for(var d=!1,l=i.bkData[t],n=0;n<i.data.length;n++){var s=i.data[n];if(l._id==s._id){d=!0;break}}d||a.Cmdbuild.utilities.proxy.deleteProcessMail(e.type,e.id,l._id,function(){},this)}},a.Cmdbuild.widgets.ManageEmail.flush=function(e,i,t,d,l,n){if(!i.data)return l||console.log(Error().stack),void l.apply(n,[]);var s=i.data.slice();a.Cmdbuild.widgets.ManageEmail.flushRecursive(e,s,i.bkData,function(){this.deleteMails(e,i),l.apply(n,[])},this)},a.Cmdbuild.widgets.ManageEmail.flushRecursive=function(e,i,t,d,l){if(i.length<=0)return void d.apply(l,[]);var n=i[0];i.splice(0,1);var s=a.grep(t,function(a){return a._id==n._id});if(s.length>0){var r=s[0];if(a.Cmdbuild.widgets.ManageEmail.isDifferent(r,n)){var o=a.Cmdbuild.widgets.ManageEmail.copyMail(n);a.Cmdbuild.utilities.proxy.putProcessMail(e.type,e.id,o._id,o,function(){a.Cmdbuild.widgets.ManageEmail.flushRecursive(e,i,t,d,l)},this)}else a.Cmdbuild.widgets.ManageEmail.flushRecursive(e,i,t,d,l)}else{var o=a.Cmdbuild.widgets.ManageEmail.copyMail(n);o._id;delete o._id,a.Cmdbuild.utilities.proxy.postProcessMail(e.type,e.id,o,function(){a.Cmdbuild.widgets.ManageEmail.flushRecursive(e,i,t,d,l)},this)}}}(jQuery),function(a){var e={data:{},saveMethod:a.Cmdbuild.widgets.SAVEAFTER,save:function(e,i){return{data:a.Cmdbuild.dataModel.getAttachmentsForWidget(e).slice(),name:i._id}},formName:function(a,e){return e.formname=a+"_"+e._id+"formattachements",e.formname},cleanData:function(e,i){var t=this.formName(e,i);a.Cmdbuild.dataModel.cleanForm(t)}};a.Cmdbuild.widgets.OpenAttachment=e,a.Cmdbuild.widgets.OpenAttachment.flush=function(e,i,t,d,l,n){var s=a.Cmdbuild.widgets.OpenAttachment.formName(d,{_id:t}),r=a.Cmdbuild.dataModel.getAttachmentsForWidget(s);if(r.length<=0)return void l.apply(n,[]);var o=r.splice(0,1)[0];a.Cmdbuild.dataModel.setAttachmentsForWidget(e.form,r),a.Cmdbuild.utilities.proxy.postInstanceAttachment(e.type,e.id,o.formdata,function(s){a.Cmdbuild.widgets.OpenAttachment.flush(e,i,t,d,l,n)},this)}}(jQuery);
//# sourceMappingURL=widgets.min.js.map